<!-- build time:Sun Nov 16 2025 03:20:47 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/avatar.jpg"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><link rel="mask-icon" href="/images/avatar.jpg" color=""><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="google-site-verification" content="7QiG8wJPa5_9Ca0Y8hlhT0rJtNqEekDbao8u-zvq7zA"><meta name="msvalidate.01" content="9A952D9AAB23A5CE98B20FC76E335FA6"><meta name="yandex-verification" content="cb2a7fddf83f1d59"><link rel="alternate" type="application/rss+xml" title="taf.fyi" href="https://taf.fyi/rss.xml"><link rel="alternate" type="application/atom+xml" title="taf.fyi" href="https://taf.fyi/atom.xml"><link rel="alternate" type="application/json" title="taf.fyi" href="https://taf.fyi/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7Cconsolas:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.6"><meta name="keywords" content="数据库"><link rel="canonical" href="https://taf.fyi/cs/db/MiniOB-2025/"><title>Mini OceanBase 2025 - 数据库 - 计算机科学</title><script src="https://unpkg.com/typed.js@2.1.0/dist/typed.umd.js" async></script><meta name="generator" content="Hexo 7.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">Mini OceanBase 2025</h1><div class="meta"><span class="item" title="Created: 2025-11-10 00:00:00"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">Posted on</span> <time itemprop="dateCreated datePublished" datetime="2025-11-10T00:00:00+08:00">2025-11-10</time> </span><span class="item" title="Symbols count in article"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">Symbols count in article</span> <span>8.9k</span> <span class="text">words</span> </span><span class="item" title="Reading time"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">Reading time</span> <span>8 mins.</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="Toggle navigation bar"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">taf.fyi</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><img src="/assets/cs/db/mini-oceanbase/ob.jpg"></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">Home</a></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/cs/" itemprop="item" rel="index" title="In 计算机科学"><span itemprop="name">计算机科学</span></a><meta itemprop="position" content="1"></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/cs/db/" itemprop="item" rel="index" title="In 数据库"><span itemprop="name">数据库</span></a><meta itemprop="position" content="2"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="en"><link itemprop="mainEntityOfPage" href="https://taf.fyi/cs/db/MiniOB-2025/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="fuuzen"><meta itemprop="description" content="taf.fyi, fuuzen 的个人主页 taf.fyi"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="taf.fyi"></span><div class="body md" itemprop="articleBody"><h1 id="参赛经历"><a class="anchor" href="#参赛经历">#</a> 参赛经历</h1><div class="note primary"><p>前情提要: <a href="https://taf.fyi/cs/db/MiniOB-2024/">Mini OceanBase 2024</a></p></div><p>2025 年 10 月底，我和去年的队友再次参加了第五届 OceanBase 数据库大赛。尽管可以提前开发，但是我们都比较忙直到初赛正式开始后才开工，耗费 2 个多星期时间，在 11 月 9 日晚上终于 AK 了今年初赛的全部题目。我们是第 26 名 AK 的队伍，也是广东省的第一。</p><p>这一次比赛，我修好了很多去年的 BUG，也成功挑战了更难的题目。截至我们 AK 为止，通过率最低的 2 道那难题 full-text-index (全文索引) 和 create-view (视图) 都由我负责完成。</p><p>对于这样复杂的项目实现复杂的功能，<mark>数据结构的设计</mark>是最重要的。数据结构设计的好，写起来就会得心应手，代码也更美观。这个过程是需要也值得多花时间的，在做后面几道难题时，我思考设计数据结构的时间基本占到总的开发时间的一半。尽管如此，依然会写着写着发现设计的有问题，然后又重新设计重写数据结构和接口，有的时候会哭笑不得的发现反复重写两三次最后又回到一开始的设计或者整个被另一个设计思路取代而删掉。</p><h1 id="关于-expression"><a class="anchor" href="#关于-expression">#</a> 关于 Expression</h1><p>今年我发现，之前数据结构的设计存在非常糟糕的问题，既出现在子查询也出现在 Order By，这个问题就是：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>E</mi><mi>x</mi><mi>p</mi><mi>r</mi><mi>e</mi><mi>s</mi><mi>s</mi><mi>i</mi><mi>o</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">Expression</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.8777699999999999em;vertical-align:-.19444em"></span><span class="mord mathnormal" style="margin-right:.05764em">E</span><span class="mord mathnormal">x</span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span></span></span></span></span></p><p>Expression 去年也是我实现的，但去年我没有意识到 Expression 的思想的重要性，毕竟当时的我没有系统学过《编译原理》。</p><p>Expression 代表的不仅仅是简单的数学计算表达式，而是一种编程语言的设计思想。在几乎所有语言设计中都一定会用它来表示全部的 <strong>右值</strong>。其实相应的，也有 “左值表达式”，那就是所有可以被赋值、被定义的东西，它当然也可以是一种表达式，只是没有那么复杂所以并不总是吸引人们的注意。这里我们讨论的 Expression 主要还是 <strong>右值表达式</strong>。</p><p>所有的编译原理课程一定会讲到 Expression 的设计，讲到他如何处理运算的优先级。而在实际写一个编译器的时候，我们总是会它用来表示：所有赋值语句的右侧、所有函数调用的传参、所有返回语句的结果...... 它无处不在。</p><p>为什么使用 Expression 后一定代码更简单、顺畅、美观？原因很简单：能很自然地复用 Expression 的逻辑和代码实现。所以 Expression 的思想归根到底还是逻辑的复用，并且同时是代码逻辑和语法解析逻辑的复用。</p><h1 id="order-by"><a class="anchor" href="#order-by">#</a> Order By</h1><p>去年我的 Order By 有一个愚蠢的设计失误：我把 Order By Operator 放在了 Project Operator 的上面 (根节点)。这是我当时想着 Order By 需要收集所有最终结果来完成排序时所得到的一个想当然的实现。这会导致 Order By Operator 只能拿到被投影过的 tuple，比如 <code>SELECT A FROM t ORDER BY B</code> 的时候就会发现 Order By Operator 根本得不到排序所需要的 B 的值。</p><p>还有一个问题就是 Expression 了，我在 <code>ORDER BY ...</code> 后面没有用 Expression 表示排序的 key。同样也是今年需要支持 Order By 后面允许函数才发现这个问题。这一问题比较好处理，切换成 Expression 比较简单，切换后非常顺畅就实现了新的需求。</p><p>至于 big-order-by 这道题目，是队友优化完成的，他的思路看起来投机取巧，不是外排序实现的。因为排序时所有的值都是 int 类型，所以他在检测到排序数据量很大时，把所有的 Value 都转化为 int，然后对 int 类型的数据排序，最后输出前慢慢转换回去。Value 改为 int 节省了很多内存，足以通过测评。</p><p>这看起来像是邪门歪道，但在真实的业务场景，倘若真的对海量数据排序，往往全都是对 int 类型数据比较，那么额外的抽象数据结构确实带来了大量冗余无用的内存负担，将它们优化掉是完全合理有必要的。</p><h1 id="子查询"><a class="anchor" href="#子查询">#</a> 子查询</h1><p>我实现的子查询没有用 Expression 表示。在今年发现 <code>UPDATE ... SET A = B</code> 这样的语句中 B 需要支持子查询时，我才意识到这个问题。子查询最终我也没有修正回 Expression 的设计，因为已经庞大复杂的代码迁移起来比较头疼，懒得再改了，我额外处理了一遍 UPDATE 的情况。</p><p>子查询还有一个非常需要注意的地方，那就是实际上子查询并非是只执行一次就够的，它的父级查询获取得到了多少个 tuple，它就需要执行多少次。例如如下这个 SQL 语句:</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t1 <span class="token keyword">WHERE</span> t1<span class="token punctuation">.</span>id <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> t2<span class="token punctuation">.</span>id <span class="token keyword">FROM</span> t2 <span class="token keyword">WHERE</span> t2<span class="token punctuation">.</span>id <span class="token operator">&lt;=</span> t1<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>这里的子查询 <code>(SELECT t2.id FROM t2 WHERE t2.id &lt;= t1.id)</code> 需要针对每一个从 t1 中获取到的 tuple 执行一次，才能得到正确的结果。所以需要注意，每一次当前查询获取到一个当前 tuple，都需要 <code>open</code> 一次子查询树，执行一遍子查询，完成相关操作后进行 <code>close</code> 。</p><p>至于父级 tuple 的信息如何向下传递给子查询呢？我的实现是基于火山模型的 <code>next</code> 方法创建了一个特殊的 <code>next_with_tuple</code> 方法，根级首次查询调用这个方法的时候放入当前自己获取到的 tuple，在经过每一级子查询语句的时候，都会把传下来的这个 tuple 上附加到子查询当前获取到的 tuple 上，这样 <code>PredicatePhysicalOperator</code> 等算子就能看到所有父级查询 tuple 信息了。</p><p>当然这一套本质上是编译原理的作用域，更加经典的实现是给每一级查询定义一个作用域，当前作用域找不到的继续到上一级作用域找。</p><h1 id="alias"><a class="anchor" href="#alias">#</a> alias</h1><p>在 alias 的实现中也需要开始实现类似作用域的处理，因为子查询需要可以创建遮蔽父级查询的 alias。</p><p>但是在实现子查询的时候，我在语义分析阶段并没有给每一级查询创建一个 <code>ExpressionBinder</code> 也就是 Field 的绑定上下文 (也就是编译原理中的变量绑定上下文)，而是把父级的上下文直接传给了子查询。所以我只好修改 <code>ExpressionBinder</code> 内部实现，让它区分哪些 alias 和表是父级查询的、哪些又是当前查询的。</p><p>我给表和 alias 查询表分别划分了 2 个集合来进行区分，在每次准备对子查询进行语义分析处理之前，把当前查询集合里的全部放到父级查询里就行了。而在进行绑定操作的时候，优先在当前查询的集合里找，找不到再到父级查询的集合里继续找，从而实现 “变量遮蔽” 的功能。</p><h1 id="union"><a class="anchor" href="#union">#</a> union</h1><p>原本的投影算子 Project 只有一个子节点，可能是 OrderBy、GroupBy、Predicate。既然 union 的几个查询列一定是相同的，那么 Project 也一定是相同的。所以我把 UNION 的所有其他查询一个接一个放到这个共同的 Project 下面，让 Project 按顺序对所有子树获取 tuple 就行了。</p><h1 id="视图"><a class="anchor" href="#视图">#</a> 视图</h1><p>在着手开始视图的开发前，我阅读参考了 2024 年同样二战 AK 入围决赛的 <span class="exturl" data-url="aHR0cHM6Ly9ibG9nLnNvdWx0ZXIudG9wL3Bvc3RzLzIwMjQtb2NlYW5iYXNlLWRhdGFiYXNlLmh0bWwjY3JlYXRlLXZpZXc=">soulter 的博客</span>。soulter 写的非常详细，整体思路描述的非常清晰，讲到了很多坑，他们甚至开源了自己的代码。不过我并没有看他们的代码，毕竟我都好不容易自己写了这么多题目了，为什么不全部自己写下去呢？</p><p>视图的实现思路主要是把视图的定义存储下来，然后在查询时把视图展开成对应的查询语句再执行。看上去非常简单，然而真正复杂的地方在<strong>视图的更新</strong>。今年这道题目官方给视图的更新写了详细的说明，以前还是没有的，所以去年 soulter 他自己测试了 MySQL 的视图更新逻辑和规则。</p><p>MySQL 会将视图的定义存到一个名为 INFORMATION_SCHEMA 的特殊的 DB/Schema 的一个特殊的表 VIEWS 之中，同时每一个视图本身所定义的 DB/Schema 和它所实际查询的表所在的 DB/Schema 可以是不同的，也就是视图的定义包含自己所在的 DB/Schema 这一属性。在 MiniOB，始终只有一个 DB/Schema <code>sys</code> ，所有的表也都放在这里面。所以简单起见我直接将视图的定义存到这个 <code>sys</code> 里的一个特殊的表 <code>__VIEWS__</code> ，并且认为所有视图都属于这个 <code>sys</code> 。我将我的表 <code>__VIEWS__</code> 设计如下：</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  @brief 存储所有视图的特殊表</pre></td></tr><tr><td data-num="3"></td><td><pre>  @ +------------+------------+------+</pre></td></tr><tr><td data-num="4"></td><td><pre>  @ | Field      | Type       | NULL |</pre></td></tr><tr><td data-num="5"></td><td><pre>  @ +------------+------------+------+</pre></td></tr><tr><td data-num="6"></td><td><pre>  @ | SCHEMA     | char (64)  |  NO  |</pre></td></tr><tr><td data-num="7"></td><td><pre>  @ | NAME       | char (64)  |  NO  |</pre></td></tr><tr><td data-num="8"></td><td><pre>  @ | ATTR_NAMES | char (255) |  YES |</pre></td></tr><tr><td data-num="9"></td><td><pre>  @ | DEFINITION | char (255) |  NO  |</pre></td></tr><tr><td data-num="10"></td><td><pre>  @ | ID         | int        |  NO  |</pre></td></tr><tr><td data-num="11"></td><td><pre>  @ +------------+------------+------+</pre></td></tr><tr><td data-num="12"></td><td><pre> */</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">const</span> <span class="token keyword">char</span> VIEWS_TABLE_NAME<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"__VIEWS__"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">const</span> <span class="token keyword">int</span> VIEWS_TABLE_FIELD_NUM <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">const</span> AttrInfoSqlNode VIEWS_TABLE_ATTRS<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  AttrInfoSqlNode<span class="token punctuation">&#123;</span>AttrType<span class="token double-colon punctuation">::</span>CHARS<span class="token punctuation">,</span> <span class="token string">"SCHEMA"</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  AttrInfoSqlNode<span class="token punctuation">&#123;</span>AttrType<span class="token double-colon punctuation">::</span>CHARS<span class="token punctuation">,</span> <span class="token string">"NAME"</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  AttrInfoSqlNode<span class="token punctuation">&#123;</span>AttrType<span class="token double-colon punctuation">::</span>CHARS<span class="token punctuation">,</span> <span class="token string">"ATTR_NAMES"</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  AttrInfoSqlNode<span class="token punctuation">&#123;</span>AttrType<span class="token double-colon punctuation">::</span>CHARS<span class="token punctuation">,</span> <span class="token string">"DEFINITION"</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  AttrInfoSqlNode<span class="token punctuation">&#123;</span>AttrType<span class="token double-colon punctuation">::</span>INTS<span class="token punctuation">,</span> <span class="token string">"ID"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>由于创建视图时可以 <code>CREATE VIEW(A, B, C, ...) AS ...</code> 的形式重新定义查询出来的列名，所以这些 <code>A,B,C</code> 信息也要存到 <code>__VIEWS__</code> 之中，也就是上面的 <code>ATTR_NAMES</code> ，我存成逗号分隔的字符串。</p><p>当然 MySQL 实际上是用 text 类型存视图的定义 SQL 语句的，然而此时我的队友 <span class="exturl" data-url="aHR0cHM6Ly9sdXZyZWFkdW5pb24uZ2l0aHViLmlv">Luv</span> 负责实现 text 还没做完，我就先用 CHARS 类型了。</p><p>那么怎么查询一个视图呢？只要能将视图视为一种特殊的表，或者说抽象的表，就能支持可能对它执行的复杂查询。soulter 的实现稍微暴力，他将需要解析的视图定义、视图名字、视图 <code>Stmt</code> 都放在了 <code>SQLStageEvent</code> 中，在处理一条 SQL 语句的每一个阶段 (语法解析 -&gt; 语义分析 -&gt; 优化 -&gt; 执行)，检查有没有视图，有的话就同时也处理视图 SQL 语句，在最后的执行阶段把视图的物理执行算子<strong>拼接</strong>到对应表的扫描算子下。</p><p>我觉得这样设计有点奇怪也不够优雅，首先有一个问题就是完全没有必要每次都解析一次查询语句，在初始化视图到内存的时候解析一次就够了，后面每次复用这个解析得到的物理执行算子树，这也是我的实现思路。</p><p>在数据库初始化的时候会将磁盘上表元数据读入内存名为 <code>Table</code> 的数据结构，MiniOB 比较暴力直接读取所有表元数据文件将全部表读入内存，由于我们不是生产级数据库暂时不考虑内存装不下所有表、视图元数据的情况。我给 <code>Table</code> 加了一个成员 <code>unique_ptr&lt;PhysicalOperator&gt;</code> 类型的 <code>query_tree_</code> 代表视图查询的物理执行树，以及一个简单的方法 <code>is_view()</code> 在这个树存在 (指针非空) 的时候返回 <code>true</code> 。数据库初始化的时候，也读取我的 <code>__VIEW__</code> 表，解析查询语句存入 <code>query_tree_</code> ，创建 <code>Table</code> 。</p><p>事实上还有一种思路是视图应该在语义分析阶段完成，也就是 <code>Optimizer</code> 里完成。将视图的展开视为一种查询语句的重写 (rewrite)，而查询语句的重写本来就是优化器需要做的事情之一，通过新增一种 <code>Rewriter</code> 来实现。</p><p>至于上面 soulter 的那个<strong>拼接</strong>过程是怎样的呢？如下是他的博客原文:</p><div class="note information"><p>在 <code>TableScanPhysicalOperator</code> 中，需要调用 <code>Table::get_record_scanner</code> 获得 <code>RecordFileScanner</code> 对象，通过 <code>RecordFileScanner::next(Record &amp;record)</code> ，以扫描表内的所有记录。 <code>RecordFileScanner</code> 类很复杂，但需要读取表的 <code>Page</code> 文件。而 <code>View</code> 就是个虚拟表，哪来的实体文件？诶 🤓，很简单，这时候之前存的 <code>View</code> 中的 <code>operator_</code> 就派上用场了，我创建了一个 <code>RecordPhysicalOperatorScanner</code> ，它的 <code>next</code> 方法就是去调用这个 <code>operator_</code> 物理算子。</p></div><p>原本扫描表的物理算子有且只有两种： <code>TableScanPhysicalOperator</code> 和 <code>IndexScanPhysicalOperator</code> ，他的实现仅处理了前者的情况，但也并没有问题，因为视图无法被创建索引，永远不会扫描视图的时候使用 <code>IndexScanPhysicalOperator</code> 。</p><p>我决定直接为表的扫描创建一个新的算子 <code>ViewScanPhysicalOperator</code> ，在生成物理执行计划的时候检查表的 <code>is_view()</code> 来决定使用该算子。这个算子和原来的 <code>TableScanPhysicalOperator</code> 没有太大差别，只需要将 <code>open</code> 、 <code>next</code> 、 <code>close</code> 、 <code>current_tuple</code> 从原本调用 <code>RecordFileScanner</code> 改为调用视图的 <code>query_tree_</code> 作为子节点。不过注意 既然选择了复用 <code>PhysicalOperator</code> ， <code>query_tree_</code> 的所有权始终是属于其所属视图 <code>Table</code> 的，所以新算子存这个查询子树要存成普通指针而不是物理执行树默认的独享指针。</p><p>现在来看最复杂的视图更新，但是复杂的更新规则实际上过滤下来会发现总是只允许视图同时更新一个基表，只需要更新的时候确定是哪一个基表，然后从那个基表的 <code>TableScanPhysicalOperator</code> 获取 RID 就行了。</p><p>soulter 的方案如下：</p><div class="note information"><p>最后（也是没有办法的办法），我给 cell，也就是 Value 类都加上了这两个信息，也就是直接把粒度放到了最小。</p></div><p>他给 tuple 的每一个 cell 也就是 <code>Value</code> 加上了 <code>RID rid_</code> 和 <code>string table_name_</code> 两个成员。这非常冗余，但是他也因此得到了另一个好处：</p><div class="note information"><p>MYSQL 不支持同时插入多表，但我这里额外实现了这个功能。很简单，在最外层循环套一个 <code>base_tables_</code> 循环，然后对每个 <code>base_table</code> ，根据 <code>attr_name_2_base_table_field_name</code> 和 <code>field_base_table_name</code> 找到对应的字段，创建 Value List 再进行插入操作即可。似乎不是很难，但很难理解为什么 MYSQL 不支持这个功能。</p></div><p>诶 🤓，你猜 MySQL 为什么不支持这个功能？因为 MySQL 没有给 tuple 的每一个 cell 加上 RID 信息。</p><p>最后我的做法则是给 <code>PhysicalOperator</code> 增加了一个方法 <code>view_update_rid()</code> ，虚类上默认实现为递归调用全部子节点的方法，在 <code>TableScanPhysicalOperator</code> 结束递归返回所需的 RID。当然只需要一个 RID，因为正如先前所述，更新的时候永远只会更新一个基表，只需要知道那一个表的当前 tuple 的 RID 即可。</p><p>上面的处理实际上仅在 UPDATE 的时候是需要的，其他更新操作并不需要 RID 信息。而 INSERT 的时候刚加简单，只需要在语义分析阶段也就是创建 <code>Stmt</code> 的时候，检查 INSERT 的字段是否来自同一个基表，否则不允许插入，是的话就记录下这个基表等到执行的时候对该表插入即可。需要注意初始化一个全为 NULL 的更新需要的 Value 列表，然后按照指定的插入字段和值填充，保证其他字段默认为 NULL。对于 DELETE，完全不允许对多基表视图操作，无需考虑。</p><h1 id="全文索引"><a class="anchor" href="#全文索引">#</a> 全文索引</h1><p>全文索引 (full-text-index) 是一道今年的新题目，实现思路主要是建立倒排索引 (Inverted Index)，将每个词语映射到包含该词语的文档列表。这样，在查询时，可以快速定位包含特定词语的文档，从而提高查询效率。</p><p>全文索引需要分词器 (tokenizer)，题目指定使用 cppjieba，应该是默认分词模式因为最后也是这样过的测评。实现分词语句比较简单，只需要创建一个二元操作 Expression 表示分词操作即可，所以我创建了 <code>TokenizeExpr</code> 。然后还需要输出一个疑似 CHARS VECTOR 的东西，为此我创建了一个只存在于内存中的 Value 数据类型，专门显示 <code>vector&lt;string&gt;</code> 分词结果。创建全文索引的上层实现也比较简单。</p><p>测试全文索引的语句疑似只有一种，形式如下：</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">SELECT</span> id<span class="token punctuation">,</span> content<span class="token punctuation">,</span> <span class="token keyword">MATCH</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span> AGAINST<span class="token punctuation">(</span><span class="token string">'某个Query'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> score \</pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token keyword">FROM</span> texts <span class="token keyword">WHERE</span> <span class="token keyword">MATCH</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span> AGAINST<span class="token punctuation">(</span><span class="token string">'某个Query'</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> \</pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token keyword">MATCH</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span> AGAINST<span class="token punctuation">(</span><span class="token string">'某个Query'</span><span class="token punctuation">)</span> <span class="token keyword">DESC</span><span class="token punctuation">,</span> id <span class="token keyword">ASC</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>首先还是需要加一个 Expression，我叫它 MatchExpr，用来识别 <code>MATCH(content) AGAINST('某个Query')</code> 。</p><p>一开始，我新加了一个 <code>OrderByPushdownRewriter</code> 在 Order By 里出现 MatchExpr 时下沉到在 <code>IndexScanner</code> 那里完成排序，然后发现这样有很大问题，我完全忘记了排序后面还有一个 <code>id ASC</code> ，而 <code>IndexScanner</code> 本身设计就不应该扫描表访问 Record，所以我也不能在这里获取 tuple 计算排序的其他键值。</p><p>那要不要改到 <code>IndexTableScanPhysicalOperator</code> 呢？这时我就发现完全没必要下沉了，B + 树索引下沉是因为完全可以去掉排序逻辑，但倒排索引只是计算 BM25 评分，还要排序的话没必要复制一份排序逻辑到底层，我只让 <code>IndexScanner</code> 提供 RID 以及相应的 BM25 评分即可。</p><p>那么，我要不要像先前实现视图时候一样搞一个火山模型上递归调用的方法获取 BM25 的值呢？这样写会发现还是有个麻烦，那就是所有会对 MatchExpr 取值的地方都要我去修改逻辑。这就很不好了，这个获取 BM25 评分的操作最好能被封装到 MatchExpr 类自己的方法里，也就是 <code>get_value(const Tuple tuple, &amp;Value value)</code> 。那么我只能将 BM25 信息放在每一次向上传递的 tuple 里，这样 MatchExpr 执行 <code>get_value</code> 的时候才能得到 BM25 信息。那么我应该像 soulter 一样在 <code>Tuple</code> 这个类里加一个成员吗？还有一个巧妙一点的办法是在 <code>IndexTableScanPhysicalOperator</code> 返回 tuple 给上层的时候加那么一个 cell 表示当前这个 RID BM25 评分。而 MatchExpr 的 <code>get_value</code> 方法中怎么找到这个 cell 呢？可以通过 TupleCellSpec 匹配，但这道题目不考虑 Join 操作，所以只有一个表，我就简单地把这个 BM25 加到原始 tuple 的最后面，MatchExpr 的 <code>get_value</code> 方法也直接从这个位置取即可。</p><p>最后我把原本的 <code>OrderByPushdownRewriter</code> 简单修改，不再 pushdown 而只是找到 ORDER BY 后面的 MatchExpr，存到 <code>TableGetLogicalOperator</code> 让其在生成物理执行计划的时候选择使用倒排索引 Index。当然，这一切都建立在整条 SQL 语句出现的 MatchExpr 始终是同一个的条件下，万一出现多种 MatchExpr，他们的 Field 和 Query 不同，那么就得对所有 Expression 做一个处理，找到所有 MatchExpr 并把他们的 Field 和 Query 往下传递，并且出现多个 Field 时，已经是 Multi Index 的情况了，太复杂我就没有再考虑。</p><p>所幸，这道题确实测试语句其实没有那么复杂，一条 SQL 语句始终只有一个 MatchExpr。我还发现系统测评实际上不会重启 observer 测试持久化，因为创建全文索引的 create 代码漏了父类 <code>Index</code> 的初始化，而读取表元数据文件 open 的代码没有问题，我本地脚本测试经常重启 observer 所以没发现 create 的问题，反而在官方测评里出现了...... 总之，过测评甚至不需要考虑持久化倒排索引信息，“内存数据库” 都能搞定。</p><p>不过我的实现当然还是老老实实持久化了的，由于倒排索引是 token 为键、所有包含该文档的相关信息为值的键值结构，我很自然地用一个简单的 Json 文件存储。我设计的 Json 结构如下：</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token property">"total_doc_num"</span><span class="token operator">:</span> <span class="token number">114514</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token property">"total_doc_len"</span><span class="token operator">:</span> <span class="token number">1919180</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token property">"inverted_index"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token property">"我是一个token"</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">350</span><span class="token punctuation">,</span> <span class="token number">234</span><span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">350</span><span class="token punctuation">,</span> <span class="token number">234</span><span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">350</span><span class="token punctuation">,</span> <span class="token number">234</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token property">"我是另一个token"</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">123</span><span class="token punctuation">,</span> <span class="token number">456</span><span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">123</span><span class="token punctuation">,</span> <span class="token number">456</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>除倒排索引本身之外还有 2 个整个表统计下来的数据 <code>total_doc_num</code> 和 <code>total_doc_len</code> ，在计算 BM25 的时候需要用到。倒排索引本身以 token 为键，值为一个列表，列表包含多个四元组。每一个四元组代表一个文档，内容为 <code>[PageNum, SlotNum, TermFreq, DocLen]</code> ，前面 2 个共同组成一个 RID，后面 2 个则同样是是计算 BM25 的时候需要用到。</p><h1 id="null"><a class="anchor" href="#null">#</a> null</h1><p>最后放一个赛博案底，Value 是 4 字节的，我存成 4 个 <code>0xEE</code> 特殊值来表示 NULL。</p><p>什么，你问我 bitmap 是啥？我不知道。</p><script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css"><div class="tags"><a href="/tags/db/" rel="tag"><i class="ic i-tag"></i> 数据库</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">Edited on</span> <time title="Modified: 2025-11-16 01:55:30" itemprop="dateModified" datetime="2025-11-16T01:55:30+08:00">2025-11-16</time> </span><span id="cs/db/MiniOB-2025/" data-flag-title="Mini OceanBase 2025" title="Views"><span class="icon"><i class="ic i-eye"></i> </span><span class="text" id="busuanzi_container_page_pv">Views <span id="busuanzi_value_page_pv"></span> times</span></span></div><div id="copyright"><ul><li class="author"><strong>Post author: </strong>fuuzen</li><li class="link"><strong>Post link: </strong><a href="https://taf.fyi/cs/db/MiniOB-2025/" title="Mini OceanBase 2025">https://taf.fyi/cs/db/MiniOB-2025/</a></li><li class="license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.</li></ul></div></footer></article></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="Contents"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%B5%9B%E7%BB%8F%E5%8E%86"><span class="toc-number">1.</span> <span class="toc-text">参赛经历</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E-expression"><span class="toc-number">2.</span> <span class="toc-text">关于 Expression</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#order-by"><span class="toc-number">3.</span> <span class="toc-text">Order By</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AD%90%E6%9F%A5%E8%AF%A2"><span class="toc-number">4.</span> <span class="toc-text">子查询</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#alias"><span class="toc-number">5.</span> <span class="toc-text">alias</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#union"><span class="toc-number">6.</span> <span class="toc-text">union</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%A7%86%E5%9B%BE"><span class="toc-number">7.</span> <span class="toc-text">视图</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%A8%E6%96%87%E7%B4%A2%E5%BC%95"><span class="toc-number">8.</span> <span class="toc-text">全文索引</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#null"><span class="toc-number">9.</span> <span class="toc-text">null</span></a></li></ol></div><div class="related panel pjax" data-title="Related"><ul><li><a href="/cs/db/linux-mssql-server/" rel="bookmark" title="在 Linux 上安装 SQL Server">在 Linux 上安装 SQL Server</a></li><li><a href="/cs/db/MiniOB-2024/" rel="bookmark" title="Mini OceanBase 2024">Mini OceanBase 2024</a></li><li class="active"><a href="/cs/db/MiniOB-2025/" rel="bookmark" title="Mini OceanBase 2025">Mini OceanBase 2025</a></li></ul></div><div class="overview panel" data-title="Overview"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="fuuzen" data-src="/images/avatar.jpg"><p class="name" itemprop="name">fuuzen</p><div class="description" itemprop="description">fuuzen 的个人主页 taf.fyi</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">24</span> <span class="name">posts</span></a></div><div class="item categories"><a href="/categories/"><span class="count">7</span> <span class="name">categories</span></a></div><div class="item tags"><a href="/tags/"><span class="count">4</span> <span class="name">tags</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL2Z1dXplbg==" title="https:&#x2F;&#x2F;github.com&#x2F;fuuzen"><i class="ic i-github"></i></span> <span class="exturl item telegram" data-url="aHR0cHM6Ly90Lm1lL2Z1dXNlbl9ub19wYXJ0eQ==" title="https:&#x2F;&#x2F;t.me&#x2F;fuusen_no_party"><i class="ic i-paper-plane"></i></span> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTE3NzMxNDU3NTU=" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;1773145755"><i class="ic i-cloud-music"></i></span> <span class="exturl item bilibili" data-url="aHR0cHM6Ly9zcGFjZS5iaWxpYmlsaS5jb20vNTE0OTI3MjkxLw==" title="https:&#x2F;&#x2F;space.bilibili.com&#x2F;514927291&#x2F;"><i class="ic i-bilibili"></i></span> <a href="/rss.xml" title="&#x2F;rss.xml" class="item rss"><i class="ic i-rss"></i></a></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>Home</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>About</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>Posts</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>Archives</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>Categories</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>Tags</a></li></ul></li><li class="item"><a href="/notebook/" rel="section"><i class="ic i-pen"></i>Notebook</a></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>Friends</a></li><li class="item"><a href="/acgn/" rel="section"><i class="ic i-magic"></i>ACGN</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"></div><div class="status"><div class="copyright">&copy; 2023 – <span itemprop="copyrightYear">2025</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">fuuzen @ taf.fyi</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-eye"></i> </span><span class="text" id="busuanzi_container_site_pv"><span id="busuanzi_value_site_pv"></span> views </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-heart"></i> </span><span class="text" id="busuanzi_container_site_uv"><span id="busuanzi_value_site_uv"></span> visitors </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="Symbols count total">177k words</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="Reading time total">2:41</span></div><div class="powered-by">Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"cs/db/MiniOB-2025/",favicon:{show:"Ciallo～(∠・ω< )⌒★!",hide:"Signaled Out"},search:{placeholder:"Search for Posts",empty:"We didn't find any results for the search: ${query}",stats:"${hits} results found in ${time} ms"},copy_tex:!0,katex:!0,fancybox:!0,copyright:'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="//fastly.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.6"></script></body></html><!-- rebuild by hrmmi -->